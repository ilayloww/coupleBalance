rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() { return request.auth != null; }

    // ── Validation helpers ──
    function isValidAmount(val) {
      return val is number && val > 0 && val < 1000000;
    }
    function isShortString(val, maxLen) {
      return val is string && val.size() <= maxLen;
    }

    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        resource.data.get('partnerUids', []).hasAny([request.auth.uid])
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        request.auth.uid == userId || 
        (
          // Allow linking/unlinking partnerUids (Multi-partner support)
          // We allow touching 'partnerUids' and legacy 'partnerUid'
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['partnerUids', 'partnerUid']) &&
          (
             // Case 1: Linking (Adding myself)
             // Ensure existing partners are kept, I am added, and size increases by exactly 1.
             (
               request.resource.data.partnerUids.hasAll(resource.data.get('partnerUids', [])) &&
               request.resource.data.partnerUids.hasAny([request.auth.uid]) &&
               request.resource.data.partnerUids.size() == resource.data.get('partnerUids', []).size() + 1
             )
             ||
             // Case 2: Unlinking (Removing myself)
             // Covers both standard unlink (I was present) and cleanup (I was missing).
             (
               // Resulting list must NOT contain me
               !request.resource.data.partnerUids.hasAny([request.auth.uid]) &&
               // New list must be subset of old (no additions)
               resource.data.get('partnerUids', []).hasAll(request.resource.data.partnerUids) &&
               // Size check:
               // If I was there: size decreases by 1
               // If I wasn't there: size stays same
               (
                 (resource.data.get('partnerUids', []).hasAny([request.auth.uid]) && request.resource.data.partnerUids.size() == resource.data.get('partnerUids', []).size() - 1) ||
                 (!resource.data.get('partnerUids', []).hasAny([request.auth.uid]) && request.resource.data.partnerUids.size() == resource.data.get('partnerUids', []).size())
               )
             )
          )
        ) ||
        (
          // Allow syncing settlement day with partner
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['settlementDay']) &&
          resource.data.get('partnerUids', []).hasAny([request.auth.uid])
        )
      );
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    match /transactions/{transactionId} {
      function isValidTransaction(data) {
        return data.keys().hasAll(['senderUid', 'receiverUid', 'amount', 'currency', 'note', 'timestamp']) &&
          data.senderUid is string &&
          data.receiverUid is string &&
          isValidAmount(data.amount) &&
          isShortString(data.currency, 5) &&
          isShortString(data.note, 500) &&
          data.timestamp is timestamp &&
          (data.senderUid == request.auth.uid || data.receiverUid == request.auth.uid) &&
          // Optional fields validation
          (!('category' in data.keys()) || isShortString(data.category, 100)) &&
          (!('photoUrl' in data.keys()) || (data.photoUrl == null || isShortString(data.photoUrl, 2048))) &&
          (!('totalAmount' in data.keys()) || (data.totalAmount == null || isValidAmount(data.totalAmount))) &&
          (!('splitPercentage' in data.keys()) || (data.splitPercentage == null || (data.splitPercentage is number && data.splitPercentage >= 0 && data.splitPercentage <= 100)));
      }

      allow read: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );
      allow create: if isAuthenticated() && isValidTransaction(request.resource.data);
      allow update: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      ) && isValidTransaction(request.resource.data);
      allow delete: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );
    }

    match /settlements/{settlementId} {
      function isValidSettlement(data) {
        return data.keys().hasAll(['payerUid', 'receiverUid', 'totalAmount', 'transactionIds', 'startDate', 'endDate', 'timestamp']) &&
          data.payerUid is string &&
          data.receiverUid is string &&
          isValidAmount(data.totalAmount) &&
          data.transactionIds is list &&
          data.startDate is timestamp &&
          data.endDate is timestamp &&
          data.timestamp is timestamp &&
          (data.payerUid == request.auth.uid || data.receiverUid == request.auth.uid);
      }

      allow read: if isAuthenticated() && (
        resource.data.payerUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );
      allow create: if isAuthenticated() && isValidSettlement(request.resource.data);
      allow update: if isAuthenticated() && (
        resource.data.payerUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      ) && isValidSettlement(request.resource.data);
      allow delete: if isAuthenticated() && (
        resource.data.payerUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );
    }

    match /settlement_requests/{requestId} {
      function isValidSettlementRequest(data) {
        return data.keys().hasAll(['senderUid', 'receiverUid', 'amount', 'currency', 'status', 'timestamp']) &&
          data.senderUid is string &&
          data.receiverUid is string &&
          isValidAmount(data.amount) &&
          isShortString(data.currency, 5) &&
          data.status is string &&
          data.status in ['PENDING', 'ACCEPTED', 'REJECTED', 'COMPLETED'] &&
          data.timestamp is timestamp;
      }

      allow read: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.senderUid == request.auth.uid &&
        isValidSettlementRequest(request.resource.data);
      allow update: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      ) && isValidSettlementRequest(request.resource.data);
      allow delete: if isAuthenticated() && resource.data.senderUid == request.auth.uid;
    }

    match /friend_requests/{requestId} {
      function isValidFriendRequest(data) {
        return data.keys().hasAll(['fromUid', 'toUid', 'status', 'createdAt']) &&
          data.fromUid is string &&
          data.toUid is string &&
          data.status is string &&
          isShortString(data.status, 20) &&
          (!('fromName' in data.keys()) || isShortString(data.fromName, 100)) &&
          (!('toName' in data.keys()) || isShortString(data.toName, 100)) &&
          (!('fromEmail' in data.keys()) || isShortString(data.fromEmail, 320)) &&
          (!('toEmail' in data.keys()) || isShortString(data.toEmail, 320));
      }

      allow read: if isAuthenticated() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
      allow create: if isAuthenticated() &&
        request.resource.data.fromUid == request.auth.uid &&
        isValidFriendRequest(request.resource.data);
      allow update: if isAuthenticated() && (
        resource.data.toUid == request.auth.uid ||
        resource.data.fromUid == request.auth.uid
      ) && isValidFriendRequest(request.resource.data);
      allow delete: if isAuthenticated() && resource.data.fromUid == request.auth.uid;
    }
  }
}
